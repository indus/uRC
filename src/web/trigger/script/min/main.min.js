angular.module("urcMirror",[]).run(function(e){e.safeApply=function(e){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)};var t="ws://127.0.0.1:8080/ws",i=new autobahn.Connection({url:t,realm:"realm1"});i.onopen=function(t){e.session=t,e.connection=i,e.$broadcast("connected"),t.register("mirror."+t.id,function(){return{id:t.id,module:"web",name:document.title,registrations:_.reduce(t.registrations,function(e,t){return e[t.procedure]=_.pick(t,"id","procedure","active"),e},{}),subscriptions:_.reduce(_.flatten(t.subscriptions),function(e,t){return e[t.topic]=_.pick(t,"id","topic","active"),e},{})}}).then(function(){e.safeApply()})},i.open()}).controller("mainCTRL",function(e){e.oPubSub={acknowledge:!1,disclose_me:!1,exclude_me:!1},e.oRpc={disclose_me:!1},e.subscribe=function(t){t&&(e.topic=null,e.session.subscribe(t,e.log).then(function(){e.safeApply()},function(e){console.error("failed to subscribe to topic",e)}))},e.unsubscribe=function(t){t&&e.session.unsubscribe(t).then(function(){e.safeApply()},function(e){console.error("failed to unsubscribe to topic",e)})},e.submit=function(){try{var t=JSON.parse(e.args||"{}"),i=e.session[{pubsub:"publish",rpc:"call"}[e.mode]](e.uri,[],t,{pubsub:e.oPubSub,rpc:e.oRpc}[e.mode]);i&&i.then(function(t){e.history.unshift({ack:t,timestamp:+new Date,type:"ack"}),e.safeApply()},function(t){e.history.unshift({error:t,timestamp:+new Date,type:"ack error"}),e.safeApply()}),e.history.unshift({payload:t,options:{pubsub:e.oPubSub,rpc:e.oRpc}[e.mode],timestamp:+new Date,type:{pubsub:"publish",rpc:"call"}[e.mode]})}catch(n){console.error(n)}},e.history=[],e.log=function(t,i,n){e.history.unshift({payload:i,details:n,timestamp:+new Date,type:"subscription"}),e.safeApply()}}).directive("validateJson",function(){return{require:"ngModel",link:function(e,t,i,n){n.$parsers.unshift(function(e){var t=!1;if(e)try{var o=JSON.parse(e);switch(i.validateJson){case"object":t=_.isPlainObject(o),n.$setValidity("jsonobject",t);break;case"array":t=_.isArray(o),n.$setValidity("jsonarray",t);break;default:t=!!o}}catch(s){}else t=!0;return n.$setValidity("json",t),t?e:void 0})}}});